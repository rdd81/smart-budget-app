<section class="transaction-shell">
  <div class="page-header">
    <div>
      <p class="eyebrow">Edit Transaction</p>
      <h1>Update transaction details</h1>
      <p class="subtitle">Modify the information below and save to keep your data accurate.</p>
    </div>
    <a routerLink="/transactions" class="ghost-button">Back to Transactions</a>
  </div>

  <div *ngIf="notFound" class="alert error" role="alert">
    This transaction could not be found or was removed.
  </div>

  <div *ngIf="loadError" class="alert error" role="alert">
    {{ loadError }}
  </div>

  <div *ngIf="successMessage" class="alert success" role="status">
    {{ successMessage }}
    <a routerLink="/transactions" class="inline-button">Return to list</a>
  </div>

  <div *ngIf="(loadingTransaction || loadingCategories) && !notFound" class="loading-state">
    <div class="spinner" aria-hidden="true"></div>
    <p>Loading transaction...</p>
  </div>

  <form
    *ngIf="!loadingTransaction && !notFound"
    [formGroup]="form"
    (ngSubmit)="onSubmit()"
    novalidate
    class="transaction-form"
  >
    <div class="form-grid">
      <div class="form-field">
        <label for="amount">Amount</label>
        <input
          id="amount"
          type="number"
          step="0.01"
          formControlName="amount"
          [class.invalid]="hasError('amount', 'required') || hasError('amount', 'min')"
        />
        <small *ngIf="hasError('amount', 'required')" class="error-message">Amount is required.</small>
        <small *ngIf="hasError('amount', 'min')" class="error-message">Amount must be greater than zero.</small>
      </div>

      <div class="form-field">
        <label for="transactionDate">Date</label>
        <input
          id="transactionDate"
          type="date"
          formControlName="transactionDate"
          [class.invalid]="hasError('transactionDate', 'required') || hasError('transactionDate', 'futureDate')"
        />
        <small *ngIf="hasError('transactionDate', 'required')" class="error-message">Date is required.</small>
        <small *ngIf="hasError('transactionDate', 'futureDate')" class="error-message">Date cannot be in the future.</small>
      </div>

      <div class="form-field full-width">
        <label for="description">Description</label>
        <input
          id="description"
          type="text"
          formControlName="description"
          maxlength="255"
          placeholder="Enter detail"
          [class.invalid]="hasError('description', 'required') || hasError('description', 'maxlength')"
        />
        <small *ngIf="hasError('description', 'required')" class="error-message">Description is required.</small>
        <small *ngIf="hasError('description', 'maxlength')" class="error-message">Maximum 255 characters.</small>
      </div>

      <div class="form-field">
        <label>Transaction Type</label>
        <div class="type-toggle" role="group" aria-label="Transaction type">
          <button
            type="button"
            [class.active]="form.controls.transactionType.value === TransactionType.EXPENSE"
            (click)="form.controls.transactionType.setValue(TransactionType.EXPENSE)"
          >
            Expense
          </button>
          <button
            type="button"
            [class.active]="form.controls.transactionType.value === TransactionType.INCOME"
            (click)="form.controls.transactionType.setValue(TransactionType.INCOME)"
          >
            Income
          </button>
        </div>
      </div>

      <div class="form-field">
        <label for="categoryId">Category</label>
        <select
          id="categoryId"
          formControlName="categoryId"
          [disabled]="filteredCategories.length === 0"
          [class.invalid]="hasError('categoryId', 'required')"
        >
          <option value="" disabled>Select category</option>
          <option *ngFor="let category of filteredCategories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
        <small *ngIf="filteredCategories.length === 0" class="muted">
          No categories available for this type.
        </small>
        <small *ngIf="hasError('categoryId', 'required')" class="error-message">Category is required.</small>
        <div class="suggestion" *ngIf="suggestion || suggestionLoading || suggestionError">
          <div class="suggestion-header">
            <span>Suggested category</span>
            <span *ngIf="suggestion" class="confidence">Confidence: {{ suggestion.confidence | number:'1.0-2' }}</span>
          </div>
          <div *ngIf="suggestionLoading" class="suggestion-loading">
            <span class="spinner inline" aria-hidden="true"></span> Checking description...
          </div>
          <div *ngIf="suggestionError" class="suggestion-error">
            {{ suggestionError }}
          </div>
          <div *ngIf="suggestion && !suggestionLoading && !suggestionError" class="suggestion-body">
            <div class="suggestion-text">
              Suggested: <strong>{{ suggestion.categoryName }}</strong>
            </div>
            <button type="button" class="ghost-button small" (click)="acceptSuggestion()">
              Use suggestion
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="ghost-button" (click)="onCancel()">Cancel</button>
      <button
        type="submit"
        class="primary-button"
        [disabled]="submitInProgress || form.invalid || loadingCategories"
      >
        <span *ngIf="submitInProgress" class="button-spinner" aria-hidden="true"></span>
        {{ submitInProgress ? 'Saving...' : 'Save Changes' }}
      </button>
    </div>

    <div *ngIf="submitError" class="alert error mt-4" role="alert">
      {{ submitError }}
    </div>
  </form>
</section>
